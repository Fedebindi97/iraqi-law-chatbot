{% extends "base.html"%}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iraqi Law Chatbot</title>
    <style>
        #chat-window { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background: #f8f9fa; }
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 80%; }
        .user-msg { background: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .bot-msg { background: #e9ecef; color: #333; align-self: flex-start; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="card mx-auto" style="max-width: 900px;">
            <div class="card-header bg-primary text-white text-center">
                {% if language == 'en' %}
                    Iraqi Law Assistant
                {% else %}
                    مساعد القانون العراقي
                {% endif %}
            </div>
            <div class="card-body d-flex flex-column" id="chat-window">
                </div>
            <div class="card-footer">
                <div class="input-group">
                    <button class="btn btn-outline-danger btn-sm" id="reset-btn" onclick="resetChat()">
                        {% if language == 'en' %}
                            New Chat
                        {% else %}
                            محادثة جديدة
                        {% endif %}
                    </button>
                    {% if language == 'en' %}
                        <input type="text" id="user-input" class="form-control" placeholder="Ask about a law...">
                    {% else %}
                        <input type="text" id="user-input" class="form-control" placeholder="اسأل عن قانون...">
                    {% endif %}
                    <button class="btn btn-primary" onclick="sendMessage()">
                        {% if language == 'en' %}
                            Send
                        {% else %}
                            إرسال
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const chatWindow = document.getElementById('chat-window');
            if (!input.value.trim()) return;

            // 1. Show user message
            chatWindow.innerHTML += `<div class="msg user-msg">${input.value}</div>`;
            const userText = input.value;
            input.value = '';

            // 2. Send to Flask
            const response = await fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userText })
            });
            const data = await response.json();

            // 3. Show bot response
            chatWindow.innerHTML += `<div class="msg bot-msg">${data.answer}</div>`;
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>

<script>
    async function resetChat() {
        //if (!confirm("Are you sure you want to clear the conversation?")) return;

        const btn = document.getElementById('reset-btn');
        const spinner = document.getElementById('reset-spinner');
        const text = document.getElementById('reset-text');
        const chatBox = document.getElementById('chat-window');

        // Show loading state
        btn.disabled = true;
        spinner.classList.remove('d-none');
        text.classList.add('d-none');

        try {
            const response = await fetch('/reset', { method: 'POST' });
            if (response.ok) {
                // Clear the visual chat box
                chatBox.innerHTML = '<div class="msg bot-msg"></div>';
            }
        } catch (error) {
            console.error("Failed to reset:", error);
        } finally {
            // Reset button state
            btn.disabled = false;
            spinner.classList.add('d-none');
            text.classList.remove('d-none');
        }
    }
</script>
<div class="container mx-auto" style="max-width: 900px; text-align: justify;">
    <p>
        {% if language == 'en' %}
            In order to chat with the Iraqi Law Chatbot, please enter your questions or topics related to Iraqi
            law in the input box above and click "Send". The chatbot will respond with relevant information
            based on its knowledge of Iraqi legal matters. Clicking "New Chat" or refreshing the page will
            restart the chatbot session, with any previous conversation history cleared. The chatbot can only
            fetch information about laws of Federal Iraq enacted since 2005 (latest constitutional period).
        {% else %}
            من أجل الدردشة مع برنامج الدردشة الآلي للقانون العراقي، يرجى إدخال أسئلتك أو المواضيع المتعلقة بالقانون العراقي
            في مربع الإدخال أعلاه والنقر على "إرسال". سيستجيب برنامج الدردشة الآلي بمعلومات ذات صلة
            بناءً على معرفته بالشؤون القانونية العراقية. النقر على "محادثة جديدة" أو تحديث الصفحة سيؤدي إلى
            إعادة تشغيل جلسة برنامج الدردشة الآلي، مع مسح أي سجل محادثة سابق. يمكن لبرنامج الدردشة الآلي فقط
            جلب المعلومات حول قوانين العراق الاتحادي التي تم سنها منذ عام 2005 (الفترة الدستورية الأخيرة).
        {% endif %}
    </p>
</div>
</body>
</html>
{% endblock %}